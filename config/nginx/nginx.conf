# ---------------------------------------------------------------------------
# Trivadis AG, Infrastructure Managed Services
# Saegereistrasse 29, 8152 Glattbrugg, Switzerland
# ---------------------------------------------------------------------------
# Name.......: nginx.conf
# Author.....: Stefan Oehrli (oes) stefan.oehrli@trivadis.com
# Editor.....: Stefan Oehrli
# Date.......: 2020.10.26
# Revision...: nginx HTTP server configuration.
# Notes......: Official English Documentation: http://nginx.org/en/docs/ 
# Reference..: --
# ---------------------------------------------------------------------------
user                        nginx;
worker_processes            auto;
error_log                   /var/log/nginx/error.log;
pid                         /run/nginx.pid;

# Load dynamic modules. See /usr/share/nginx/README.dynamic.
include                     /usr/share/nginx/modules/*.conf;

events {
    worker_connections      1024;
}

http {
    log_format              main    '$remote_addr - $remote_user [$time_local] "$request" '
                                    '$status $body_bytes_sent "$http_referer" '
                                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log              /var/log/nginx/access.log  main;

    sendfile                on;
    tcp_nopush              on;
    tcp_nodelay             on;
    keepalive_timeout       65;
    types_hash_max_size     2048;

    include                 /etc/nginx/mime.types;
    default_type            application/octet-stream;

    # Load modular configuration files from the /etc/nginx/conf.d directory.
    # See http://nginx.org/en/docs/ngx_core_module.html#include
    # for more information.
    include                 /etc/nginx/conf.d/*.conf;

    ssl config files 
    ssl_certificate     /etc/letsencrypt/live/otemplate-bastion00.trivadislabs.com/fullchain.pem; 
    ssl_certificate_key /etc/letsencrypt/live/otemplate-bastion00.trivadislabs.com/privkey.pem; 
    include             /etc/letsencrypt/options-ssl-nginx.conf; 
    ssl_dhparam         /etc/letsencrypt/ssl-dhparams.pem; 

    # Default Proxy Server Configuration
    server {
        listen              80 default_server;
        listen              [::]:80 default_server;
        server_name         _;

        location / {
            proxy_pass      http://www.trivadislabs.com;
        }
    }

    # Proxy Server Configuration
    server {
        server_name         $hostname.trivadislabs.com; 
        location / {
            proxy_pass      http://www.trivadislabs.com;
        }

        location /guacamole {
            proxy_pass      http://guacamole:8080/guacamole;
            proxy_buffering off;
            proxy_http_version 1.1;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $http_connection;
            proxy_cookie_path /guacamole/ /;
        }
        # listen              80 ;
        # listen              [::]:80 ;
        listen              [::]:443 ssl; 
        listen              443 ssl; 
    }

    forward all request to HTTPS
    server {
        if ($host = $hostname.trivadislabs.com) {
            return          301 https://$host$request_uri;
        }

        listen              80 ;
        listen              [::]:80 ;
        server_name         $hostname.trivadislabs.com;
        return              404; 
    }
}
# --- EOF --------------------------------------------------------------------